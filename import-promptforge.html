<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Importar PromptForge - Wikiprompts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
</head>

<body class="bg-gray-50 p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="window.location.href='admin.html'"
                    class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 transition-colors">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h1 class="text-3xl font-bold">üé® Importar Prompts de PromptForge</h1>
            </div>

            <div class="bg-purple-50 border-l-4 border-purple-400 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-symbols-outlined text-purple-400">palette</span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-purple-700">
                            <strong>Fuente:</strong> <a href="https://github.com/intelligencedev/PromptForge"
                                target="_blank" class="underline">intelligencedev/PromptForge</a><br>
                            Este proceso importar√° colecciones de estilos, luces, c√°maras y materiales como prompts
                            visuales.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <h3 class="font-medium text-gray-900 mb-2">Colecciones a Importar</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="file-source form-checkbox h-5 w-5 text-purple-600"
                                value="STYLES.json" checked>
                            <span class="ml-2 text-sm text-gray-700">Estilos Art√≠sticos (STYLES.json)</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="file-source form-checkbox h-5 w-5 text-purple-600"
                                value="LIGHTS.json" checked>
                            <span class="ml-2 text-sm text-gray-700">Efectos de Luz (LIGHTS.json)</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="file-source form-checkbox h-5 w-5 text-purple-600"
                                value="THEMES.json" checked>
                            <span class="ml-2 text-sm text-gray-700">Temas y Entornos (THEMES.json)</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="file-source form-checkbox h-5 w-5 text-purple-600"
                                value="CAMERA.json" checked>
                            <span class="ml-2 text-sm text-gray-700">C√°mara y √Ångulos (CAMERA.json)</span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" class="file-source form-checkbox h-5 w-5 text-purple-600"
                                value="MATERIALS.json" checked>
                            <span class="ml-2 text-sm text-gray-700">Materiales (MATERIALS.json)</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Autor Asignado:</label>
                    <input type="text" id="defaultAuthor" value="@intelligencedev"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
                </div>
            </div>

            <button onclick="startImport()" id="importBtn"
                class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined">download</span>
                Iniciar Importaci√≥n
            </button>

            <div id="progress" class="mt-6 hidden">
                <div class="bg-gray-100 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold">Progreso General:</h3>
                        <span id="progressText" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressBar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                    <div id="statusLog"
                        class="mt-4 max-h-96 overflow-y-auto bg-white rounded p-3 border border-gray-200">
                        <pre id="logContent" class="text-xs text-gray-700 whitespace-pre-wrap font-mono"></pre>
                    </div>
                </div>
            </div>

            <div id="results" class="mt-6 hidden">
                <div class="bg-green-50 border-l-4 border-green-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-green-400">check_circle</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-green-700">
                                <strong id="successCount">0</strong> prompts importados exitosamente.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Usar la misma URL que en admin.html y app.js para evitar errores de Mixed Content
        const API_URL = 'https://sentences-col-vice-antivirus.trycloudflare.com/api';
        const BASE_REPO_URL = 'https://raw.githubusercontent.com/intelligencedev/PromptForge/main';


        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            let icon = '‚ÑπÔ∏è';
            if (type === 'error') icon = '‚ùå';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'warning') icon = '‚ö†Ô∏è';

            logContent.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            if (text) document.getElementById('progressText').textContent = text;
        }

        async function fetchJSON(filename) {
            const response = await fetch(`${BASE_REPO_URL}/${filename}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }

        async function checkImage(url) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
            });
        }

        async function startImport() {
            const checkboxes = document.querySelectorAll('.file-source:checked');
            const filesToImport = Array.from(checkboxes).map(cb => cb.value);
            const defaultAuthor = document.getElementById('defaultAuthor').value;

            if (filesToImport.length === 0) {
                alert('Por favor selecciona al menos una colecci√≥n.');
                return;
            }

            // UI Setup
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('logContent').textContent = '';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importBtn').classList.add('opacity-50', 'cursor-not-allowed');

            let totalImported = 0;
            let totalItems = 0;
            let processedItems = 0;

            try {
                // Primero obtenemos todos los datos para saber el total
                const collections = [];
                log('Descargando archivos JSON...');

                for (const file of filesToImport) {
                    try {
                        const data = await fetchJSON(file);
                        // Aplanar la estructura: { "Category": [items] } -> [items con categoria]
                        let items = [];
                        for (const [groupName, groupItems] of Object.entries(data)) {
                            items = items.concat(groupItems.map(item => ({ ...item, group: groupName })));
                        }
                        collections.push({ file, items });
                        totalItems += items.length;
                        log(`Cargado ${file}: ${items.length} items`, 'success');
                    } catch (e) {
                        log(`Error cargando ${file}: ${e.message}`, 'error');
                    }
                }

                log(`Total a procesar: ${totalItems} items. Comenzando importaci√≥n...`);

                // Obtener prompts existentes para evitar duplicados innecesarios (opcional optimizaci√≥n)
                const existingPrompts = await fetch(`${API_URL}/prompts`).then(r => r.json()).catch(() => []);
                const existingIds = new Set(existingPrompts.map(p => p.id));

                for (const collection of collections) {
                    for (const item of collection.items) {
                        processedItems++;
                        const percent = Math.round((processedItems / totalItems) * 100);
                        updateProgress(percent, `${percent}% (${processedItems}/${totalItems})`);

                        // Construir el prompt
                        // Tag suele tener guiones, lo hacemos title legible
                        const itemsTitle = item.tag.replace(/-/g, ' ');
                        const promptId = `pf-${item.tag}`; // ID √∫nico basado en el tag

                        if (existingIds.has(promptId)) {
                            log(`Saltando ${item.tag} (ya existe)`, 'warning');
                            continue;
                        }

                        // Intentar determinar imagen
                        // La repo dice: underscores for spaces in image names. 
                        // Pero los tags ya vienen con guiones. Asumimos el nombre del archivo es el tag tal cual o con underscores.
                        // Probaremos ambas extensiones png y jpg
                        const baseImageName = item.tag;
                        const possibleUrls = [
                            `${BASE_REPO_URL}/images/${baseImageName}.png`,
                            `${BASE_REPO_URL}/images/${baseImageName}.jpg`,
                            `${BASE_REPO_URL}/images/${baseImageName.replace(/-/g, '_')}.png`,
                            `${BASE_REPO_URL}/images/${baseImageName.replace(/-/g, '_')}.jpg`
                        ];

                        let validImageUrl = '';

                        // Verificaci√≥n r√°pida de imagen (opcional, puede hacer lento el proceso)
                        // Para hacerlo m√°s r√°pido, asignamos la PNG por defecto y confiamos, o hacemos un HEAD.
                        // Dado que son muchos, mejor intentamos la m√°s probable.
                        // El README dice que los nombres coinciden con el tag.
                        // Usaremos la primera opci√≥n por defecto.
                        validImageUrl = possibleUrls[0];

                        const promptData = {
                            id: promptId,
                            title: itemsTitle,
                            category: 'visuals',
                            type: 'image', // Asumimos visual
                            model: 'PromptForge',
                            prompt: item.description,
                            description: `Colecci√≥n: ${collection.file.replace('.json', '')} - ${item.group}`,
                            author: defaultAuthor,
                            likes: 0,
                            views: 0,
                            createdAt: new Date().toISOString(),
                            imageUrl: validImageUrl,
                            tags: [item.group, collection.file.replace('.json', '')]
                        };

                        try {
                            await fetch(`${API_URL}/prompts/${promptData.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(promptData)
                            });
                            totalImported++;
                            // log(`Importado: ${item.tag}`, 'success'); // Muy ruidoso si son muchos
                        } catch (e) {
                            log(`Error guardando ${item.tag}: ${e.message}`, 'error');
                        }

                        // Peque√±a pausa cada 10 items para no bloquear UI
                        if (processedItems % 10 === 0) await new Promise(r => setTimeout(r, 10));
                    }
                }

                document.getElementById('results').classList.remove('hidden');
                document.getElementById('successCount').textContent = totalImported;
                log(`Proceso finalizado. ${totalImported} prompts nuevos importados.`, 'success');

            } catch (error) {
                log(`Error general: ${error.message}`, 'error');
            } finally {
                document.getElementById('importBtn').disabled = false;
                document.getElementById('importBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    </script>
</body>

</html>