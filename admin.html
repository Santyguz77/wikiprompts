<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <title>Administración - Wikiprompts</title>

    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" href="/image.png" />

    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Manrope:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0a0a0a",
                        "secondary": "#666666",
                        "accent": "#000000",
                        "background": "#ffffff",
                        "surface": "#fafafa",
                        "border": "#e5e5e5",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Manrope", "sans-serif"],
                    },
                    boxShadow: {
                        'subtle': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    },
                },
            },
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 20px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-body">
    <!-- Modal de confirmación -->
    <div id="confirmModal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100">
                        <span class="material-symbols-outlined text-red-600 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900" id="confirmTitle">Eliminar prompt</h3>
                    </div>
                </div>
                <p class="text-gray-600 text-sm leading-relaxed mb-6" id="confirmMessage">
                    ¿Estás seguro de que quieres eliminar este prompt? Esta acción no se puede deshacer.
                </p>
                <div class="flex gap-3">
                    <button onclick="cancelConfirm()"
                        class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Cancelar
                    </button>
                    <button onclick="acceptConfirm()"
                        class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="relative mx-auto flex h-full min-h-screen w-full max-w-7xl flex-col bg-gray-50 pb-8">

        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 p-4 lg:px-8 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='index.html'"
                        class="flex size-10 items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <h1 class="text-2xl lg:text-3xl font-display font-bold tracking-tight text-gray-900">Panel de
                        Administración</h1>
                </div>
                <div class="flex items-center gap-2 lg:gap-3">
                    <button onclick="window.location.href='import-github.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold hover:bg-blue-700 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">download</span>
                        <span class="hidden lg:inline">GitHub</span>
                    </button>
                    <button onclick="window.location.href='import-promptforge.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">palette</span>
                        <span class="hidden lg:inline">PromptForge</span>
                    </button>
                    <button onclick="window.location.href='import-nano-banana.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-yellow-500 text-white rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">nutrition</span>
                        <span class="hidden lg:inline">Nano Banana</span>
                    </button>
                    <button onclick="window.location.href='import-claude-templates.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">smart_toy</span>
                        <span class="hidden lg:inline">Claude</span>
                    </button>
                    <button onclick="window.location.href='update-github-prompts.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold hover:bg-purple-700 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">update</span>
                        <span class="hidden lg:inline">Actualizar</span>
                    </button>
                    <button onclick="window.location.href='delete-github-prompts.html'"
                        class="flex items-center gap-2 px-3 lg:px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                        <span class="hidden lg:inline">Eliminar</span>
                    </button>
                    <div
                        class="hidden lg:flex items-center gap-2 px-4 py-2 bg-red-100 rounded-full border border-red-200">
                        <span class="material-symbols-outlined text-red-600 text-[18px]">shield</span>
                        <span class="text-sm font-semibold text-red-600">Admin</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-6 lg:p-8 space-y-8">

            <!-- Analytics Overview -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-500">visibility</span>
                            <span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Visitas Totales</span>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">Hoy</span>
                    </div>
                    <p id="totalVisits" class="text-4xl font-bold text-gray-900 font-display">0</p>
                    <p class="text-sm text-gray-400 mt-2">Últimos 30 días</p>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-500">description</span>
                            <span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Prompts Activos</span>
                        </div>
                    </div>
                    <p id="totalPrompts" class="text-4xl font-bold text-gray-900 font-display">0</p>
                    <p class="text-sm text-gray-400 mt-2">En todas las categorías</p>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm cursor-pointer hover:shadow-md transition-shadow group"
                    onclick="showUsersModal()">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span
                                class="material-symbols-outlined text-gray-500 group-hover:text-black transition-colors">group</span>
                            <span
                                class="text-sm font-bold text-gray-500 group-hover:text-black transition-colors uppercase tracking-wide">Usuarios</span>
                        </div>
                        <span
                            class="material-symbols-outlined text-gray-300 group-hover:text-black transition-colors text-sm">open_in_new</span>
                    </div>
                    <p id="totalUsers" class="text-4xl font-bold text-gray-900 font-display">0</p>
                    <p class="text-sm text-gray-400 mt-2">Click para ver lista</p>
                </div>
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-gray-500">favorite</span>
                            <span class="text-sm font-bold text-gray-500 uppercase tracking-wide">Engagement</span>
                        </div>
                    </div>
                    <p id="totalLikes" class="text-4xl font-bold text-gray-900 font-display">0</p>
                    <p class="text-sm text-gray-400 mt-2">Likes totales</p>
                </div>
            </section>

            <!-- Modal de Usuarios -->
            <div id="usersModal"
                class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[85vh] flex flex-col">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xl font-bold font-display">Usuarios Registrados</h3>
                        <button onclick="document.getElementById('usersModal').classList.add('hidden')"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                            <span class="material-symbols-outlined text-gray-500">close</span>
                        </button>
                    </div>
                    <div class="overflow-auto p-6 custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-sm text-gray-400 font-medium border-b border-gray-100">
                                    <th class="pb-3 pl-2 font-semibold">Usuario</th>
                                    <th class="pb-3 font-semibold">Email</th>
                                    <th class="pb-3 font-semibold">Username</th>
                                    <th class="pb-3 font-semibold">Registro</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="text-sm text-gray-600">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Visits Chart -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 font-display">Tráfico del Sitio</h3>
                    <div class="w-full h-80">
                        <canvas id="visitsChart"></canvas>
                    </div>
                </div>

                <!-- Top Prompts Table -->
                <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm overflow-hidden flex flex-col">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 font-display">Prompts Más Populares</h3>
                    <div class="overflow-y-auto flex-1 pr-2 custom-scrollbar">
                        <div id="topPromptsList" class="flex flex-col gap-4">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Management Section -->
            <section class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <div
                    class="p-6 border-b border-gray-200 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-xl font-display font-bold text-gray-900">Gestión de Contenido</h2>
                    <div class="flex gap-2">
                        <select id="filterCategory" onchange="filterPrompts()"
                            class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium focus:border-black focus:ring-0">
                            <option value="all">Todas las categorías</option>
                            <option value="visuals">Visuales</option>
                            <option value="coding">Código</option>
                            <option value="writing">Escritura</option>
                            <option value="marketing">Marketing</option>
                        </select>
                        <div class="relative">
                            <span
                                class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400 text-[20px]">search</span>
                            <input type="text" placeholder="Buscar prompt..."
                                class="pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium focus:border-black focus:ring-0 w-64">
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <div id="promptsList" class="grid grid-cols-1 gap-4">
                        <!-- Prompts List -->
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        const API_URL = 'https://sentences-col-vice-antivirus.trycloudflare.com/api';
        let allPrompts = [];
        let allUsers = [];
        let chartInstance = null;
        let confirmCallback = null;

        // Configuración global de Chart.js
        Chart.defaults.font.family = "'Manrope', sans-serif";
        Chart.defaults.color = '#64748b';

        // Verificar admin
        async function checkAdmin() {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'auth.html';
                return false;
            }
            const user = JSON.parse(storedUser);
            if (user.email !== 'santyguz777@gmail.com' && user.username !== 'santyguz77') {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Cargar Dashboard
        async function loadDashboard() {
            // 1. Cargar Datos Críticos (Prompts y Usuarios) primero para que la gestión funcione siempre
            try {
                const [promptsRes, usersRes, likesRes] = await Promise.allSettled([
                    fetch(`${API_URL}/prompts`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_URL}/auth_users`).then(r => r.ok ? r.json() : []),
                    fetch(`${API_URL}/likes`).then(r => r.json())
                ]);

                // Procesar resultados (usar array vacío si falló)
                const prompts = promptsRes.status === 'fulfilled' ? promptsRes.value : [];
                const users = usersRes.status === 'fulfilled' ? usersRes.value : [];
                const likes = likesRes.status === 'fulfilled' ? likesRes.value : [];

                allPrompts = prompts;
                allUsers = users;

                document.getElementById('totalPrompts').innerText = prompts.length.toLocaleString();
                document.getElementById('totalUsers').innerText = users.length.toLocaleString();
                document.getElementById('totalLikes').innerText = Array.isArray(likes) ? likes.reduce((sum, l) => sum + (l.count || 1), 0).toLocaleString() : '0';

                renderPromptsList(prompts);
            } catch (error) {
                console.error('Error cargando datos principales:', error);
                document.getElementById('promptsList').innerHTML = '<p class="text-red-500 text-center py-4">Error cargando datos: ' + error.message + '</p>';
            }

            // 2. Cargar Analytics (No bloqueante)
            try {
                const analyticsRes = await fetch(`${API_URL}/analytics/dashboard`, { credentials: 'include' });
                if (analyticsRes.ok) {
                    const analytics = await analyticsRes.json();

                    document.getElementById('totalVisits').innerText = analytics.totalVisits.toLocaleString();
                    renderChart(analytics.visits);
                    renderTopPrompts(analytics.topPrompts);
                } else {
                    console.warn('Analytics endpoint returned error status');
                }
            } catch (error) {
                console.error('Error cargando analytics (probablemente falta reiniciar servidor):', error);
                // No mostrar error en UI para no asustar, solo dejar en 0
            }
        }

        function showUsersModal() {
            const tbody = document.getElementById('usersTableBody');
            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No hay usuarios cargados</td></tr>';
            } else {
                tbody.innerHTML = allUsers.map(u => `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                        <td class="py-3 pl-2 flex items-center gap-3">
                            <div class="size-8 rounded-full bg-gray-200 overflow-hidden bg-cover bg-center" style="background-image: url('${u.avatar || ''}');">
                                ${!u.avatar ? '<div class="w-full h-full flex items-center justify-center"><span class="material-symbols-outlined text-gray-400 text-xs">person</span></div>' : ''}
                            </div>
                            <span class="font-semibold text-gray-900">${u.name || 'Sin nombre'}</span>
                        </td>
                        <td class="py-3 text-gray-500">${u.email}</td>
                        <td class="py-3 font-mono text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-md inline-block my-2">@${u.username}</td>
                        <td class="py-3 text-gray-400">${new Date(u.createdAt).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
            document.getElementById('usersModal').classList.remove('hidden');
        }

        function renderChart(visitsData) {
            const ctx = document.getElementById('visitsChart').getContext('2d');

            // Preparar datos (rellenar días faltantes si es necesario, aquí asumimos que vienen ordenados)
            const labels = visitsData.map(d => new Date(d.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
            const data = visitsData.map(d => d.count);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visitas',
                        data: data,
                        borderColor: '#000000',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(0,0,0,0.1)');
                            gradient.addColorStop(1, 'rgba(0,0,0,0)');
                            return gradient;
                        },
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#000000',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#000',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: (context) => ` ${context.raw} visitas`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9', borderDash: [5, 5] },
                            ticks: { precision: 0 }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderTopPrompts(prompts) {
            const container = document.getElementById('topPromptsList');
            container.innerHTML = prompts.map((p, index) => `
                <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 transition-colors cursor-pointer border border-transparent hover:border-gray-100" onclick="window.location.href='prompt-detail.html'">
                    <div class="flex items-center justify-center size-8 rounded-full bg-gray-100 font-bold text-sm text-gray-500">
                        ${index + 1}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-900 text-sm truncate">${p.title}</p>
                        <div class="flex gap-2 text-xs text-gray-500">
                            <span>${p.category}</span>
                            <span>•</span>
                            <span>${p.author}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 text-xs font-bold text-gray-700 bg-gray-100 px-2 py-1 rounded-full">
                        <span class="material-symbols-outlined text-[14px]">visibility</span>
                        ${p.views}
                    </div>
                </div>
            `).join('');
        }

        function renderPromptsList(prompts) {
            const container = document.getElementById('promptsList');
            if (prompts.length === 0) {
                container.innerHTML = '<p class="text-center py-8 text-gray-400">No se encontraron prompts</p>';
                return;
            }

            container.innerHTML = prompts.slice(0, 20).map(prompt => `
                <div class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:border-black/20 transition-all">
                    <div class="flex items-center gap-4 overflow-hidden">
                        ${prompt.imageUrl ?
                    `<img src="${prompt.imageUrl}" class="size-12 rounded-lg object-cover bg-gray-100" alt="">` :
                    `<div class="size-12 rounded-lg bg-gray-100 flex items-center justify-center"><span class="material-symbols-outlined text-gray-400">article</span></div>`
                }
                        <div class="min-w-0">
                            <h3 class="font-bold text-gray-900 truncate">${prompt.title}</h3>
                            <p class="text-sm text-gray-500 truncate">por ${prompt.author} • ${prompt.model}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                         <div class="hidden md:flex flex-col items-end mr-4">
                            <span class="text-xs font-bold text-gray-900">${prompt.views || 0} vistas</span>
                            <span class="text-xs text-gray-400">${new Date(prompt.createdAt).toLocaleDateString()}</span>
                        </div>
                        <button onclick="window.location.href='contribute.html?edit=true'" class="size-9 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-500 transition-colors">
                            <span class="material-symbols-outlined text-[20px]">edit</span>
                        </button>
                        <button onclick="deletePrompt('${prompt.id}')" class="size-9 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-[20px]">delete</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Sistema de Filtrado
        function filterPrompts() {
            const category = document.getElementById('filterCategory').value;
            const filtered = category === 'all' ? allPrompts : allPrompts.filter(p => p.category === category);
            renderPromptsList(filtered);
        }

        // Eliminar (mismo lógica anterior)
        function deletePrompt(promptId) {
            const prompt = allPrompts.find(p => p.id === promptId);
            if (!prompt) return;
            showConfirm('Eliminar prompt', `¿Eliminar "${prompt.title}"?`, async () => {
                try {
                    await fetch(`${API_URL}/prompts/${promptId}`, { method: 'DELETE' });
                    // No need to delete associated comments/likes manually if using SQL foreign keys, 
                    // but keeping it simple: just reload for now or manual cleanup in backend ideally.
                    // Recargar
                    loadDashboard();
                } catch (e) {
                    console.error(e);
                    alert('Error al eliminar');
                }
            });
        }

        function showConfirm(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }
        function cancelConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }
        function acceptConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmCallback) { confirmCallback(); confirmCallback = null; }
        }

        // Init
        window.addEventListener('DOMContentLoaded', async () => {
            if (await checkAdmin()) {
                loadDashboard();
            }
        });

    </script>
</body>

</html>