<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <title>Prompt Detail - Wikiprompts</title>

    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" href="/image.png" />

    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&family=Manrope:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5747426531124165"
        crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#2563EB",
                        "secondary": "#64748B",
                        "bg-page": "#FFFFFF",
                        "bg-subtle": "#F3F4F6",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "body": ["Manrope", "sans-serif"],
                        "mono": ["Noto Sans Mono", "monospace"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "full": "9999px" },
                },
            },
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom scrollbar for prompt text */
        .overflow-y-auto::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 20px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Firefox scrollbar */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: #e5e7eb transparent;
        }
    </style>
</head>

<body class="bg-bg-page text-gray-900 font-body selection:bg-gray-200 overflow-x-hidden">
    <!-- Modal de confirmaci√≥n personalizado -->
    <div id="confirmModal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
            <div class="p-6">
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100">
                        <span class="material-symbols-outlined text-red-600 text-2xl">warning</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900" id="confirmTitle">Confirmar acci√≥n</h3>
                    </div>
                </div>
                <p class="text-gray-600 text-sm leading-relaxed mb-6" id="confirmMessage">
                    ¬øEst√°s seguro de que quieres continuar?
                </p>
                <div class="flex gap-3">
                    <button onclick="cancelConfirm()"
                        class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors">
                        Cancelar
                    </button>
                    <button onclick="acceptConfirm()"
                        class="flex-1 px-4 py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-colors">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de notificaci√≥n -->
    <div id="toast"
        class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-[10000] transform transition-all duration-300">
        <div class="bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[280px]">
            <span class="material-symbols-outlined text-[20px]">check_circle</span>
            <span id="toastMessage" class="text-sm font-medium">Acci√≥n completada</span>
        </div>
    </div>

    <div class="relative mx-auto flex h-full min-h-screen w-full max-w-md lg:max-w-none flex-col shadow-xl bg-white">

        <!-- Header -->
        <header
            class="sticky top-0 z-50 flex items-center justify-between p-4 lg:px-12 lg:py-6 bg-white/90 backdrop-blur-md border-b border-gray-100">
            <button onclick="goBack()"
                class="flex size-10 lg:size-12 items-center justify-center rounded-full text-gray-900 hover:bg-gray-100 transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 class="text-base lg:text-lg font-semibold font-display tracking-tight text-gray-900">Detalle del Prompt
            </h1>
            <div class="flex gap-2">
                <button id="editBtn" onclick="editPrompt()"
                    class="hidden flex size-10 lg:size-12 items-center justify-center rounded-full text-gray-900 hover:bg-gray-100 transition-colors">
                    <span class="material-symbols-outlined">edit</span>
                </button>
                <button onclick="sharePrompt()"
                    class="flex size-10 lg:size-12 items-center justify-center rounded-full text-gray-900 hover:bg-gray-100 transition-colors">
                    <span class="material-symbols-outlined">share</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col pb-24">
            <div class="px-6 lg:px-12 xl:px-24 py-6 lg:py-8 max-w-5xl lg:mx-auto w-full">
                <!-- Image Gallery (if applicable) -->
                <div id="imageGallery" class="w-full max-w-4xl mx-auto mb-8 hidden">
                    <!-- Imagen principal -->
                    <div class="relative aspect-video bg-gray-50 rounded-2xl overflow-hidden shadow-lg mb-4">
                        <img id="mainImage" src="" alt="" class="w-full h-full object-cover">
                        <div class="absolute bottom-4 right-4 flex gap-2">
                            <button onclick="fullscreenImage()"
                                class="size-10 flex items-center justify-center rounded-full bg-white/90 shadow-sm text-gray-700 hover:text-black transition-colors backdrop-blur-sm">
                                <span class="material-symbols-outlined text-[20px]">fullscreen</span>
                            </button>
                            <button onclick="downloadImage()"
                                class="size-10 flex items-center justify-center rounded-full bg-white/90 shadow-sm text-gray-700 hover:text-black transition-colors backdrop-blur-sm">
                                <span class="material-symbols-outlined text-[20px]">download</span>
                            </button>
                        </div>
                    </div>
                    <!-- Miniaturas -->
                    <div id="thumbnailsContainer" class="grid grid-cols-5 gap-2">
                        <!-- Se llenar√°n din√°micamente -->
                    </div>
                </div>

                <div class="flex flex-col gap-8">
                    <!-- Prompt Content -->
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-base lg:text-lg font-bold text-gray-900 uppercase tracking-wide">El Prompt
                            </h2>
                            <button onclick="copyPrompt()"
                                class="group flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-900 hover:text-white rounded-lg transition-all">
                                <span class="material-symbols-outlined text-[18px]">content_copy</span>
                                <span>Copiar</span>
                            </button>
                        </div>
                        <div
                            class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 lg:p-8 rounded-2xl border border-gray-200 shadow-sm max-h-96 overflow-y-auto">
                            <p id="promptText"
                                class="text-gray-800 text-base lg:text-lg leading-relaxed font-mono break-words overflow-wrap-anywhere">
                            </p>
                        </div>
                    </div>

                    <!-- Metadata -->
                    <div>
                        <div id="metadata"
                            class="flex flex-wrap items-start justify-between gap-y-4 py-4 border-t border-b border-gray-100">
                            <!-- Se llenar√° din√°micamente -->
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center justify-start gap-6 pt-4">
                            <button onclick="toggleLike()" id="likeBtn"
                                class="flex items-center gap-2 text-gray-500 hover:text-red-500 transition-colors group">
                                <span class="material-symbols-outlined group-hover:fill-current"
                                    style="font-variation-settings: 'FILL' 0;">favorite</span>
                                <span id="likeCount" class="text-sm">0</span>
                            </button>
                            <button class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors">
                                <span class="material-symbols-outlined">chat_bubble</span>
                                <span id="commentCount" class="text-sm">0</span>
                            </button>
                            <button onclick="sharePrompt()"
                                class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors ml-auto">
                                <span class="material-symbols-outlined">ios_share</span>
                            </button>
                            <button onclick="toggleBookmark()" id="bookmarkBtn"
                                class="flex items-center gap-2 text-gray-500 hover:text-gray-900 transition-colors">
                                <span class="material-symbols-outlined">bookmark</span>
                            </button>
                        </div>
                    </div>

                    <!-- Author Section -->
                    <div id="authorSection"
                        class="bg-gradient-to-br from-gray-50 to-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4 cursor-pointer" onclick="viewAuthorProfile()">
                                <div id="authorAvatar"
                                    class="size-12 rounded-full bg-gray-200 overflow-hidden flex items-center justify-center flex-shrink-0">
                                    <span class="material-symbols-outlined text-gray-400 text-2xl">person</span>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-semibold text-gray-900" id="authorName">Autor</span>
                                    <span class="text-xs text-gray-500" id="authorUsername">@username</span>
                                </div>
                            </div>
                            <button id="followBtn" onclick="toggleFollow(event)"
                                class="hidden px-5 py-2 rounded-full text-sm font-semibold transition-all">
                                <span id="followBtnText">Seguir</span>
                            </button>
                        </div>
                    </div>

                    <!-- More from Category -->
                    <div class="flex flex-col gap-4" id="relatedPromptsSection">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold font-display text-gray-900">M√°s de <span
                                    id="categoryName"></span></h3>
                        </div>
                        <div id="relatedPromptsGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-8">
                            <!-- Se cargar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="flex flex-col gap-4">
                        <h3 class="text-lg font-bold font-display text-gray-900">Comentarios</h3>

                        <!-- Add Comment Form -->
                        <div id="addCommentSection" class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <textarea id="commentInput" placeholder="Escribe un comentario..." rows="3"
                                class="w-full px-4 py-3 bg-white border border-gray-200 rounded-lg focus:border-black focus:ring-0 transition-colors text-sm resize-none"></textarea>
                            <div class="flex justify-end gap-2 mt-3">
                                <button onclick="addComment()"
                                    class="px-5 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">
                                    Publicar
                                </button>
                            </div>
                        </div>

                        <div id="commentsContainer" class="flex flex-col gap-6">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <div class="fixed bottom-6 right-6 z-50">
            <button onclick="remixPrompt()"
                class="flex items-center justify-center size-14 rounded-full bg-black text-white shadow-lg hover:scale-105 transition-transform hover:shadow-xl">
                <span class="material-symbols-outlined text-[24px]">auto_fix_high</span>
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'https://sentences-col-vice-antivirus.trycloudflare.com/api';

        let currentUser = null;

        // Verificar autenticaci√≥n
        function checkAuth() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                return true;
            }
            return false;
        }

        // Sistema de confirmaci√≥n modal personalizado
        let confirmCallback = null;

        function showConfirm(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function cancelConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        function acceptConfirm() {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        }

        // Sample comments data
        const sampleComments = [
            {
                username: 'cyber_artist',
                avatar: 'https://lh3.googleusercontent.com/aida-public/AB6AXuB9OT8Mm_FDGfpvK-s_yjNZktUN3ijEQWnPRAQpwMQoUzIqQrZNjMA-2ZUuZY2yOGUut0jsMm7cSYV2b7JGyPv2qIJFNZ_uXH1ohzk0InMlNUqNdarcMhXXgSnN0a82OUn9EyGqVbAgYenubkVjEEi9yfWA2r6XMiq3KMzHO30r6MxNrJ0QiTOYJa-hTs3Ak7kOs_lJNumTQmAQQY-pJece283odvKZO_msZHtNSuOCWwwjQGF1pvkPYyBa0FaZElWRQzOi0EPVg8eW',
                text: 'La iluminaci√≥n en este es incre√≠ble. ¬øUsaste alg√∫n valor espec√≠fico de --s?',
                time: '2h ago'
            },
            {
                username: 'neo_tokyo',
                avatar: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDH9uj0hfLmX2zNdk7RIFdNbyUh5RZHbGqO8kZDE08qXhSXdh32lMNsyYX-cUWWNsuv5AwM7vmLVL1xe6wboQxT-t9gD_HSGLtKlmsoriVgIe4o0to1xPH1MsJ0AirTIb-3SmLw2mn-0B7W-p_TiuCucs1twUnRPMDZDLfSjxbT7siiBZi_YcBOUUkUfIXRTyjNOjzmLYn_Vrk9ieco8w4Zkg_q_dqav20yImlTML5390ODuptAW0wrSWIYPBjynOAnhAShm0E4KYK3',
                text: 'Me encantan los reflejos en el pavimento mojado. Midjourney 6 es incre√≠ble.',
                time: '5h ago'
            }
        ];

        async function init() {
            try {
                const promptId = sessionStorage.getItem('currentPromptId');

                if (!promptId) {
                    alert('Prompt no encontrado');
                    goBack();
                    return;
                }

                // Analytics: Registrar vista
                fetch(`${API_URL}/analytics/prompt/${promptId}`, { method: 'POST' }).catch(console.error);

                console.log('üîÑ Cargando prompt del servidor...');
                const [prompts, comments] = await Promise.all([
                    fetch(`${API_URL}/prompts`).then(r => r.json()),
                    fetch(`${API_URL}/comments`).then(r => r.json())
                ]);

                const prompt = prompts.find(p => p.id === promptId);

                if (!prompt) {
                    alert('Prompt no encontrado');
                    goBack();
                    return;
                }

                displayPrompt(prompt);

                // Filtrar comentarios de este prompt
                const promptComments = comments.filter(c => c.promptId === promptId);
                displayComments(promptComments);
                document.getElementById('commentCount').textContent = promptComments.length;
            } catch (error) {
                console.error('‚ùå Error cargando prompt:', error);
                alert('Error al cargar el prompt');
                goBack();
            }
        }

        function displayPrompt(prompt) {
            const isAuthenticated = checkAuth();
            window.currentPrompt = prompt; // Guardar globalmente para editar

            // Mostrar bot√≥n de editar solo si el usuario es el autor O ADMIN
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (currentUser) {
                const userIdentifier = currentUser.username ? '@' + currentUser.username : currentUser.name;
                // Verificar si es administrador
                const isAdmin = currentUser.email === 'santyguz777@gmail.com' || currentUser.username === 'santyguz77';

                if (prompt.author === userIdentifier || isAdmin) {
                    document.getElementById('editBtn').classList.remove('hidden');
                }
            }

            // Display images gallery if exists
            const images = prompt.images || (prompt.imageUrl ? [prompt.imageUrl] : []);
            if (images.length > 0) {
                displayImageGallery(images);
            }

            // Display prompt text
            const promptTextElement = document.getElementById('promptText');
            if (isAuthenticated) {
                promptTextElement.textContent = prompt.prompt;
            } else {
                promptTextElement.innerHTML = `
                    <div class="flex flex-col items-center justify-center gap-4 py-8">
                        <span class="material-symbols-outlined text-gray-300 text-5xl">lock</span>
                        <div class="text-center">
                            <p class="text-gray-900 font-semibold mb-2">Contenido Bloqueado</p>
                            <p class="text-gray-500 text-sm mb-4">Reg√≠strate o inicia sesi√≥n para ver el prompt completo</p>
                            <button onclick="window.location.href='auth.html'" class="px-6 py-2 bg-black text-white rounded-lg font-medium hover:bg-gray-800 transition-colors">
                                Iniciar Sesi√≥n
                            </button>
                        </div>
                    </div>
                `;
            }

            // Display metadata
            const metadata = document.getElementById('metadata');
            metadata.innerHTML = `
                <div class="flex flex-col gap-0.5">
                    <span class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold">Modelo</span>
                    <span class="text-sm font-medium text-gray-900">${prompt.model}</span>
                </div>
                <div class="flex flex-col gap-0.5">
                    <span class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold">Categor√≠a</span>
                    <span class="text-sm font-medium text-gray-900">${getCategoryLabel(prompt.category)}</span>
                </div>
                <div class="flex flex-col gap-0.5">
                    <span class="text-[11px] uppercase tracking-wider text-gray-400 font-semibold">Autor</span>
                    <span class="text-sm font-medium text-gray-900">${prompt.author}</span>
                </div>
            `;

            // Display likes
            document.getElementById('likeCount').textContent = prompt.likes || 0;
            document.getElementById('commentCount').textContent = sampleComments.length;

            // Check if bookmarked
            checkBookmarkStatus(prompt.id);

            // Check if liked by current user
            checkLikeStatus(prompt.id);

            // Load related prompts from same category
            loadRelatedPrompts(prompt.category, prompt.id);

            // Display author section
            displayAuthorSection(prompt);
        }

        async function checkBookmarkStatus(promptId) {
            try {
                const [bookmarks, likes] = await Promise.all([
                    fetch(`${API_URL}/bookmarks`).then(r => r.json()),
                    fetch(`${API_URL}/likes`).then(r => r.json())
                ]);

                // Check bookmark - filtrar por usuario actual
                const bookmarkBtn = document.getElementById('bookmarkBtn');
                const bookmarkIcon = bookmarkBtn.querySelector('.material-symbols-outlined');
                if (currentUser) {
                    const userId = currentUser.id || currentUser.email;
                    const hasBookmarked = bookmarks.some(b => b.promptId === promptId && b.userId === userId);
                    if (hasBookmarked) {
                        bookmarkIcon.style.fontVariationSettings = "'FILL' 1";
                    }
                }

                // Check like
                if (currentUser) {
                    const userId = currentUser.id || currentUser.email;
                    const hasLiked = likes.some(l => l.promptId === promptId && l.userId === userId);
                    if (hasLiked) {
                        const likeBtn = document.getElementById('likeBtn');
                        const likeIcon = likeBtn.querySelector('.material-symbols-outlined');
                        likeIcon.style.fontVariationSettings = "'FILL' 1";
                        likeBtn.classList.remove('text-gray-500');
                        likeBtn.classList.add('text-red-500');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error verificando bookmark/like:', error);
            }
        }

        function displayComments(comments) {
            const container = document.getElementById('commentsContainer');

            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">chat_bubble</span>
                        <p class="text-sm">A√∫n no hay comentarios. ¬°S√© el primero!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = comments.map(comment => {
                const timeAgo = getTimeAgo(comment.createdAt);
                const avatar = comment.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(comment.username)}&background=random`;

                // Verificar si es el comentario del usuario actual
                const isOwn = currentUser && (
                    comment.userId === (currentUser.id || currentUser.email) ||
                    comment.username === currentUser.username ||
                    comment.username === currentUser.name
                );

                const deleteButton = isOwn ? `
                    <button 
                        onclick="deleteComment('${comment.id}')" 
                        class="text-red-500 hover:text-red-700 transition-colors"
                        title="Borrar comentario"
                    >
                        <span class="material-symbols-outlined text-[18px]">delete</span>
                    </button>
                ` : '';

                return `
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden">
                            <img alt="${comment.username}" class="w-full h-full object-cover" src="${avatar}"/>
                        </div>
                        <div class="flex flex-col gap-1 flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-gray-900">${comment.username}</span>
                                <span class="text-xs text-gray-400">${timeAgo}</span>
                                ${deleteButton}
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">${comment.text}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteComment(commentId) {
            showConfirm(
                'Eliminar comentario',
                '¬øEst√°s seguro de que quieres borrar este comentario? Esta acci√≥n no se puede deshacer.',
                async () => {
                    try {
                        const comments = await fetch(`${API_URL}/comments`).then(r => r.json());
                        const updatedComments = comments.filter(c => c.id !== commentId);

                        await fetch(`${API_URL}/comments`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updatedComments)
                        });

                        // Actualizar UI
                        const promptId = sessionStorage.getItem('currentPromptId');
                        const promptComments = updatedComments.filter(c => c.promptId === promptId);
                        displayComments(promptComments);
                        document.getElementById('commentCount').textContent = promptComments.length;

                        console.log('‚úÖ Comentario eliminado');
                    } catch (error) {
                        console.error('‚ùå Error eliminando comentario:', error);
                        alert('Error al borrar comentario. Intenta de nuevo.');
                    }
                }
            );
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'ahora';
            if (seconds < 3600) return `hace ${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `hace ${Math.floor(seconds / 3600)}h`;
            if (seconds < 604800) return `hace ${Math.floor(seconds / 86400)}d`;
            return date.toLocaleDateString();
        }

        async function addComment() {
            if (!checkAuth()) {
                alert('Debes iniciar sesi√≥n para comentar');
                window.location.href = 'auth.html';
                return;
            }

            const commentInput = document.getElementById('commentInput');
            const text = commentInput.value.trim();

            if (!text) {
                alert('Escribe un comentario primero');
                return;
            }

            const promptId = sessionStorage.getItem('currentPromptId');

            try {
                const comments = await fetch(`${API_URL}/comments`).then(r => r.json());

                const newComment = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    promptId: promptId,
                    userId: currentUser.id || currentUser.email,
                    username: currentUser.username || currentUser.name,
                    avatar: currentUser.avatar || null,
                    text: text,
                    createdAt: new Date().toISOString()
                };

                comments.push(newComment);

                await fetch(`${API_URL}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(comments)
                });

                // Actualizar UI
                commentInput.value = '';
                const promptComments = comments.filter(c => c.promptId === promptId);
                displayComments(promptComments);
                document.getElementById('commentCount').textContent = promptComments.length;

                console.log('‚úÖ Comentario agregado');
            } catch (error) {
                console.error('‚ùå Error agregando comentario:', error);
                alert('Error al publicar comentario. Intenta de nuevo.');
            }
        }

        function getCategoryLabel(category) {
            const labels = {
                'visuals': 'Visuales',
                'coding': 'C√≥digo',
                'writing': 'Escritura',
                'marketing': 'Marketing'
            };
            return labels[category] || category;
        }

        async function loadRelatedPrompts(category, currentPromptId) {
            try {
                const prompts = await fetch(`${API_URL}/prompts`).then(r => r.json());

                // Filtrar prompts de la misma categor√≠a, excluyendo el actual
                const relatedPrompts = prompts
                    .filter(p => p.category === category && p.id !== currentPromptId)
                    .slice(0, 4); // Mostrar m√°ximo 4

                // Actualizar el nombre de la categor√≠a en el t√≠tulo
                document.getElementById('categoryName').textContent = getCategoryLabel(category);

                // Renderizar prompts relacionados
                const grid = document.getElementById('relatedPromptsGrid');
                grid.innerHTML = relatedPrompts.map(prompt => createPromptCard(prompt)).join('');
            } catch (error) {
                console.error('Error cargando prompts relacionados:', error);
            }
        }

        function createPromptCard(prompt) {
            const imageUrl = prompt.images?.[0] || prompt.imageUrl || '';

            if (prompt.type === 'image') {
                return `
                    <article class="group flex flex-col gap-3 cursor-pointer" onclick="viewPrompt('${prompt.id}')">
                        <div class="relative aspect-[3/4] rounded-2xl overflow-hidden bg-gray-50 ring-1 ring-black/5">
                            <img alt="${prompt.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" src="${imageUrl}"/>
                            <div class="absolute top-3 left-3 bg-white/95 backdrop-blur-md px-2 py-0.5 rounded-full shadow-sm">
                                <span class="text-[9px] font-bold uppercase tracking-wider text-black">${prompt.model}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-0.5 px-1">
                            <h3 class="font-display font-semibold text-[15px] leading-tight text-primary group-hover:text-gray-600 transition-colors">${prompt.title}</h3>
                            <p class="text-[11px] font-medium text-gray-400">${prompt.author || 'An√≥nimo'}</p>
                        </div>
                    </article>
                `;
            } else if (prompt.type === 'text') {
                return `
                    <article class="group flex flex-col gap-3 cursor-pointer" onclick="viewPrompt('${prompt.id}')">
                        <div class="relative aspect-[3/4] rounded-2xl bg-white border border-gray-100 p-5 flex flex-col justify-between hover:shadow-sm hover:border-gray-200 transition-all">
                            <div class="w-2 h-2 rounded-full bg-black"></div>
                            <p class="font-body text-[11px] leading-relaxed text-gray-500 line-clamp-6">
                                <span class="font-semibold text-black">Prompt:</span> ${prompt.prompt.substring(0, 150)}...
                            </p>
                            <div class="bg-gray-50 px-2 py-1 rounded-md self-start border border-gray-100">
                                <span class="text-[9px] font-bold uppercase tracking-wider text-gray-400">${prompt.model}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-0.5 px-1">
                            <h3 class="font-display font-semibold text-[15px] leading-tight text-primary group-hover:text-gray-600 transition-colors">${prompt.title}</h3>
                            <p class="text-[11px] font-medium text-gray-400">${prompt.author || 'An√≥nimo'}</p>
                        </div>
                    </article>
                `;
            } else if (prompt.type === 'code') {
                return `
                    <article class="group flex flex-col gap-3 cursor-pointer" onclick="viewPrompt('${prompt.id}')">
                        <div class="relative aspect-[3/4] rounded-2xl bg-gray-900 p-5 flex flex-col overflow-hidden shadow-lg shadow-gray-200">
                            <div class="flex items-center gap-1.5 opacity-50 mb-4">
                                <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                                <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                            </div>
                            <div class="font-mono text-[10px] text-gray-400 leading-relaxed">
                                ${prompt.codePreview ? prompt.codePreview.split('\n').slice(0, 4).map(line => `<div>${line}</div>`).join('') : ''}
                            </div>
                        </div>
                        <div class="flex flex-col gap-0.5 px-1">
                            <h3 class="font-display font-semibold text-[15px] leading-tight text-primary group-hover:text-gray-600 transition-colors">${prompt.title}</h3>
                            <p class="text-[11px] font-medium text-gray-400">${prompt.model}</p>
                        </div>
                    </article>
                `;
            }
        }

        function viewPrompt(promptId) {
            sessionStorage.setItem('currentPromptId', promptId);
            window.location.reload();
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function copyPrompt() {
            if (!checkAuth()) {
                showToast('Debes iniciar sesi√≥n para copiar prompts', 'error');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 1500);
                return;
            }

            const promptText = document.getElementById('promptText').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                showToast('Prompt copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar:', err);
                showToast('Error al copiar el prompt', 'error');
            });
        }

        // Funci√≥n para mostrar toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('.material-symbols-outlined');
            const container = toast.querySelector('div');

            // Configurar √≠cono y colores seg√∫n el tipo
            if (type === 'success') {
                icon.textContent = 'check_circle';
                container.className = 'bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[280px]';
            } else if (type === 'error') {
                icon.textContent = 'error';
                container.className = 'bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 min-w-[280px]';
            }

            toastMessage.textContent = message;

            // Mostrar con animaci√≥n
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(0)';
                toast.style.opacity = '1';
            }, 10);

            // Ocultar despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(-20px)';
                toast.style.opacity = '0';
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        async function toggleLike() {
            if (!checkAuth()) {
                alert('Debes iniciar sesi√≥n para dar me gusta');
                window.location.href = 'auth.html';
                return;
            }

            const likeBtn = document.getElementById('likeBtn');
            const icon = likeBtn.querySelector('.material-symbols-outlined');
            const likeCountEl = document.getElementById('likeCount');
            const currentFill = icon.style.fontVariationSettings;
            const promptId = sessionStorage.getItem('currentPromptId');

            try {
                // Obtener likes y prompts actuales
                const [likes, prompts] = await Promise.all([
                    fetch(`${API_URL}/likes`).then(r => r.json()),
                    fetch(`${API_URL}/prompts`).then(r => r.json())
                ]);

                const prompt = prompts.find(p => p.id === promptId);
                if (!prompt) return;

                const userId = currentUser.id || currentUser.email;
                const existingLike = likes.find(l => l.promptId === promptId && l.userId === userId);

                let newLikes;
                if (existingLike) {
                    // Unlike
                    icon.style.fontVariationSettings = "'FILL' 0";
                    likeBtn.classList.remove('text-red-500');
                    likeBtn.classList.add('text-gray-500');
                    newLikes = likes.filter(l => l.id !== existingLike.id);
                    prompt.likes = Math.max(0, (prompt.likes || 0) - 1);
                } else {
                    // Like
                    icon.style.fontVariationSettings = "'FILL' 1";
                    likeBtn.classList.remove('text-gray-500');
                    likeBtn.classList.add('text-red-500');
                    newLikes = [...likes, {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                        promptId: promptId,
                        userId: userId,
                        createdAt: new Date().toISOString()
                    }];
                    prompt.likes = (prompt.likes || 0) + 1;
                }

                // Actualizar contador visual
                likeCountEl.textContent = prompt.likes;

                // Guardar en servidor
                await Promise.all([
                    fetch(`${API_URL}/likes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newLikes)
                    }),
                    fetch(`${API_URL}/prompts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(prompts)
                    })
                ]);

                console.log('‚úÖ Like actualizado');
            } catch (error) {
                console.error('‚ùå Error actualizando like:', error);
                alert('Error al actualizar. Intenta de nuevo.');
            }
        }

        async function toggleBookmark() {
            if (!checkAuth()) {
                alert('Debes iniciar sesi√≥n para guardar prompts');
                window.location.href = 'auth.html';
                return;
            }

            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const icon = bookmarkBtn.querySelector('.material-symbols-outlined');
            const currentFill = icon.style.fontVariationSettings || "'FILL' 0";
            const promptId = sessionStorage.getItem('currentPromptId');
            const userId = currentUser.id || currentUser.email;

            try {
                // Obtener bookmarks o inicializar array vac√≠o si no existe
                let bookmarks = [];
                try {
                    const response = await fetch(`${API_URL}/bookmarks`);
                    if (response.ok) {
                        bookmarks = await response.json();
                        // Asegurar que sea un array
                        if (!Array.isArray(bookmarks)) {
                            bookmarks = [];
                        }
                    }
                } catch (fetchError) {
                    console.log('Inicializando bookmarks...');
                    bookmarks = [];
                }

                if (currentFill.includes("'FILL' 1")) {
                    // Remove bookmark
                    icon.style.fontVariationSettings = "'FILL' 0";
                    bookmarks = bookmarks.filter(b => !(b.promptId === promptId && b.userId === userId));
                } else {
                    // Add bookmark
                    icon.style.fontVariationSettings = "'FILL' 1";
                    const existingBookmark = bookmarks.find(b => b.promptId === promptId && b.userId === userId);
                    if (!existingBookmark) {
                        bookmarks.push({
                            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                            promptId: promptId,
                            userId: userId,
                            createdAt: new Date().toISOString()
                        });
                    }
                }

                const saveResponse = await fetch(`${API_URL}/bookmarks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookmarks)
                });

                if (!saveResponse.ok) {
                    throw new Error('Error al guardar en el servidor');
                }

                console.log('‚úÖ Bookmark actualizado');
            } catch (error) {
                console.error('‚ùå Error actualizando bookmark:', error);
                alert('Error al guardar. Intenta de nuevo.');
                // Revertir el icono
                icon.style.fontVariationSettings = currentFill;
            }
        }

        // Verificar estado de bookmark al cargar
        async function checkBookmarkStatus(promptId) {
            if (!checkAuth()) return;

            try {
                const bookmarks = await fetch(`${API_URL}/bookmarks`).then(r => r.json());
                const userId = currentUser.id || currentUser.email;
                const userBookmark = bookmarks.find(b => b.promptId === promptId && b.userId === userId);

                const bookmarkBtn = document.getElementById('bookmarkBtn');
                const icon = bookmarkBtn.querySelector('.material-symbols-outlined');

                if (userBookmark) {
                    icon.style.fontVariationSettings = "'FILL' 1";
                } else {
                    icon.style.fontVariationSettings = "'FILL' 0";
                }
            } catch (error) {
                console.error('Error verificando bookmark:', error);
            }
        }

        // Verificar estado de like al cargar
        async function checkLikeStatus(promptId) {
            if (!checkAuth()) return;

            try {
                const likes = await fetch(`${API_URL}/likes`).then(r => r.json());
                const userId = currentUser.id || currentUser.email;
                const userLike = likes.find(l => l.promptId === promptId && l.userId === userId);

                const likeBtn = document.getElementById('likeBtn');
                const icon = likeBtn.querySelector('.material-symbols-outlined');

                if (userLike) {
                    icon.style.fontVariationSettings = "'FILL' 1";
                    likeBtn.classList.remove('text-gray-500');
                    likeBtn.classList.add('text-red-500');
                } else {
                    icon.style.fontVariationSettings = "'FILL' 0";
                    likeBtn.classList.remove('text-red-500');
                    likeBtn.classList.add('text-gray-500');
                }
            } catch (error) {
                console.error('Error verificando like:', error);
            }
        }

        function sharePrompt() {
            if (navigator.share) {
                navigator.share({
                    title: 'Mira este prompt en Wikiprompts',
                    url: window.location.href
                });
            } else {
                alert('Funci√≥n de compartir no disponible en este navegador');
            }
        }

        function remixPrompt() {
            window.location.href = 'contribute.html';
        }

        function editPrompt() {
            if (!window.currentPrompt) return;

            // Guardar el prompt actual para edici√≥n
            sessionStorage.setItem('editingPrompt', JSON.stringify(window.currentPrompt));
            window.location.href = 'contribute.html?edit=true';
        }

        // Mostrar galer√≠a de im√°genes
        function displayImageGallery(images) {
            const gallery = document.getElementById('imageGallery');
            const mainImage = document.getElementById('mainImage');
            const thumbnailsContainer = document.getElementById('thumbnailsContainer');

            gallery.classList.remove('hidden');

            // Establecer primera imagen como principal
            mainImage.src = images[0];
            mainImage.alt = window.currentPrompt?.title || 'Imagen';

            // Si hay m√°s de una imagen, mostrar miniaturas
            if (images.length > 1) {
                thumbnailsContainer.innerHTML = images.map((img, index) => `
                    <button 
                        onclick="changeMainImage('${img.replace(/'/g, "\\'")}', ${index})"
                        class="aspect-square rounded-lg overflow-hidden border-2 ${index === 0 ? 'border-black' : 'border-gray-200 hover:border-gray-400'} transition-all"
                        id="thumbnail-${index}"
                    >
                        <img src="${img}" alt="Imagen ${index + 1}" class="w-full h-full object-cover">
                    </button>
                `).join('');
            } else {
                thumbnailsContainer.classList.add('hidden');
            }
        }

        // Cambiar imagen principal
        window.changeMainImage = function (imageUrl, index) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = imageUrl;

            // Actualizar bordes de miniaturas
            const allThumbnails = document.querySelectorAll('[id^="thumbnail-"]');
            allThumbnails.forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.remove('border-gray-200', 'hover:border-gray-400');
                    thumb.classList.add('border-black');
                } else {
                    thumb.classList.remove('border-black');
                    thumb.classList.add('border-gray-200', 'hover:border-gray-400');
                }
            });
        }

        function fullscreenImage() {
            const mainImage = document.getElementById('mainImage');
            if (mainImage && mainImage.requestFullscreen) {
                mainImage.requestFullscreen();
            }
        }

        async function downloadImage() {
            if (!window.currentPrompt) {
                showToast('No hay imagen para descargar', true);
                return;
            }

            // Obtener la imagen actualmente mostrada
            const mainImage = document.getElementById('mainImage');
            const imageUrl = mainImage ? mainImage.src : (window.currentPrompt.images?.[0] || window.currentPrompt.imageUrl);

            if (!imageUrl) {
                showToast('No hay imagen para descargar', true);
                return;
            }

            try {
                // Si la imagen es base64, descargar directamente
                if (imageUrl.startsWith('data:')) {
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = `${window.currentPrompt.title || 'prompt'}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Imagen descargada correctamente');
                } else {
                    // Si es URL externa, intentar descargar
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${window.currentPrompt.title || 'prompt'}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    showToast('Imagen descargada correctamente');
                }
            } catch (error) {
                console.error('Error descargando imagen:', error);
                // Si falla el fetch, abrir en nueva pesta√±a
                window.open(imageUrl, '_blank');
                showToast('Imagen abierta en nueva pesta√±a');
            }
        }

        // Mostrar secci√≥n del autor
        async function displayAuthorSection(prompt) {
            const authorName = document.getElementById('authorName');
            const authorUsername = document.getElementById('authorUsername');
            const authorAvatar = document.getElementById('authorAvatar');
            const followBtn = document.getElementById('followBtn');

            // Extraer informaci√≥n del autor del prompt
            const author = prompt.author;

            // Mostrar nombre y username
            if (author.startsWith('@')) {
                authorUsername.textContent = author;
                authorName.textContent = author.substring(1);
            } else {
                authorName.textContent = author;
                authorUsername.textContent = '@' + author.toLowerCase().replace(/\s+/g, '');
            }

            // Cargar avatar del autor desde la base de datos de usuarios
            try {
                const response = await fetch(`${API_URL}/auth_users`);
                console.log('üì° Response status:', response.status);

                if (!response.ok) {
                    console.error('‚ùå Error en respuesta:', response.status, response.statusText);
                    return;
                }

                const users = await response.json();
                console.log('üë• Datos recibidos:', users);
                console.log('üë• Es array?:', Array.isArray(users));
                console.log('üîç Buscando autor:', author);

                // Verificar que users sea un array
                if (!Array.isArray(users)) {
                    console.error('‚ùå users no es un array, es:', typeof users);
                    return;
                }

                // Buscar usuario por username o nombre (m√°s flexible)
                const authorUser = users.find(u => {
                    // Normalizar para comparaci√≥n
                    const promptAuthor = author.toLowerCase().replace('@', '');
                    const userName = (u.name || '').toLowerCase();
                    const userUsername = (u.username || '').toLowerCase();

                    return userName === promptAuthor ||
                        userUsername === promptAuthor ||
                        userName.replace(/\s+/g, '') === promptAuthor ||
                        author === u.name ||
                        author === '@' + u.username;
                });

                console.log('‚úÖ Usuario encontrado:', authorUser);

                if (authorUser && authorUser.avatar) {
                    console.log('üñºÔ∏è Mostrando avatar');
                    authorAvatar.style.backgroundImage = `url(${authorUser.avatar})`;
                    authorAvatar.style.backgroundSize = 'cover';
                    authorAvatar.style.backgroundPosition = 'center';
                    authorAvatar.innerHTML = '';
                } else {
                    console.log('‚ö†Ô∏è No se encontr√≥ avatar');
                }

                // Guardar info del autor para navegaci√≥n
                window.authorUserData = authorUser;

            } catch (error) {
                console.error('‚ùå Error cargando avatar:', error);
            }

            // Mostrar bot√≥n de seguir solo si NO es el autor actual
            if (currentUser) {
                const userIdentifier = currentUser.username ? '@' + currentUser.username : currentUser.name;
                if (prompt.author !== userIdentifier) {
                    followBtn.classList.remove('hidden');
                    await checkFollowStatus(prompt.author);
                }
            }
        }

        // Verificar si ya sigue al autor
        async function checkFollowStatus(authorIdentifier) {
            if (!currentUser) return;

            try {
                const followers = await fetch(`${API_URL}/followers`).then(r => r.json());
                const userId = currentUser.id || currentUser.email;

                // Buscar si ya sigue a este autor
                // Nota: Necesitamos el ID del autor, no solo el nombre
                // Por ahora usamos el identificador como referencia
                const isFollowing = followers.some(f =>
                    f.followerId === userId && f.followingUsername === authorIdentifier
                );

                updateFollowButton(isFollowing);
            } catch (error) {
                console.error('Error verificando follow status:', error);
            }
        }

        // Actualizar apariencia del bot√≥n de seguir
        function updateFollowButton(isFollowing) {
            const followBtn = document.getElementById('followBtn');
            const followBtnText = document.getElementById('followBtnText');

            if (isFollowing) {
                followBtn.className = 'px-5 py-2 rounded-full text-sm font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
                followBtnText.textContent = 'Siguiendo';
            } else {
                followBtn.className = 'px-5 py-2 rounded-full text-sm font-semibold transition-all bg-black text-white hover:bg-gray-800';
                followBtnText.textContent = 'Seguir';
            }
        }

        // Toggle seguir/dejar de seguir
        async function toggleFollow(event) {
            event.stopPropagation();

            if (!checkAuth()) {
                alert('Debes iniciar sesi√≥n para seguir usuarios');
                window.location.href = 'auth.html';
                return;
            }

            const followBtnText = document.getElementById('followBtnText');
            const isFollowing = followBtnText.textContent === 'Siguiendo';
            const authorUsername = document.getElementById('authorUsername').textContent;

            try {
                const followers = await fetch(`${API_URL}/followers`).then(r => r.json());
                const userId = currentUser.id || currentUser.email;

                let newFollowers;
                if (isFollowing) {
                    // Dejar de seguir
                    newFollowers = followers.filter(f =>
                        !(f.followerId === userId && f.followingUsername === authorUsername)
                    );
                    showToast('Dejaste de seguir a este usuario');
                } else {
                    // Seguir
                    const newFollow = {
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                        followerId: userId,
                        followingUsername: authorUsername,
                        createdAt: new Date().toISOString()
                    };
                    newFollowers = [...followers, newFollow];
                    showToast('Ahora sigues a este usuario');
                }

                // Guardar en servidor usando PUT para operaci√≥n at√≥mica
                await fetch(`${API_URL}/followers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newFollowers)
                });

                // Actualizar UI
                updateFollowButton(!isFollowing);

            } catch (error) {
                console.error('Error al seguir/dejar de seguir:', error);
                showToast('Error al actualizar. Intenta de nuevo.', 'error');
            }
        }

        // Ver perfil del autor
        function viewAuthorProfile() {
            const authorUsername = document.getElementById('authorUsername').textContent;

            // Si es el usuario actual, ir a su perfil
            if (currentUser) {
                const userIdentifier = currentUser.username ? '@' + currentUser.username : '@' + currentUser.name.toLowerCase().replace(/\s+/g, '');

                if (authorUsername === userIdentifier) {
                    window.location.href = 'profile.html';
                    return;
                }
            }

            // Si es otro usuario, ir a su perfil p√∫blico
            const username = authorUsername.replace('@', '');
            window.location.href = `user-profile.html?username=${encodeURIComponent(username)}`;
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>